<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart - Saiteja's Store</title>
</head>
<body>
  <h2>Your Cart</h2>
  <div id="cart-items"></div>
  <p><strong>Total:</strong> ₹<span id="total">0</span></p>
  <button id="checkout-btn">Checkout</button>
  <p id="status"></p>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaThueFE1Z0nXK_FL3H3gWs-roE8RfxV0",
      authDomain: "ecommercest-f71db.firebaseapp.com",
      projectId: "ecommercest-f71db",
      storageBucket: "ecommercest-f71db.firebasestorage.app",
      messagingSenderId: "1053281704673",
      appId: "1:1053281704673:web:b59b1b83c1e3a850cab5a0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const cartItemsContainer = document.getElementById("cart-items");
    const totalDisplay = document.getElementById("total");
    const checkoutBtn = document.getElementById("checkout-btn");
    const status = document.getElementById("status");

    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let currentUser = null;

    // Render cart items
    function renderCart() {
      cartItemsContainer.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        cartItemsContainer.innerHTML = "<p>Your cart is empty.</p>";
        checkoutBtn.disabled = true;
        return;
      }

      cart.forEach(item => {
        total += item.price;
        cartItemsContainer.innerHTML += `
          <div style="margin-bottom:10px;">
            <strong>${item.name}</strong> - ₹${item.price}
          </div>
        `;
      });

      totalDisplay.textContent = total;
      checkoutBtn.disabled = false;
    }

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        status.textContent = "❌ You must be logged in to checkout.";
        checkoutBtn.disabled = true;
      } else {
        currentUser = user;
        status.textContent = "";
        renderCart();
      }
    });

    // Checkout handler
    checkoutBtn.addEventListener("click", async () => {
      if (!currentUser) {
        status.textContent = "❌ Please log in first.";
        return;
      }

      if (cart.length === 0) {
        status.textContent = "❌ Your cart is empty.";
        return;
      }

      const totalAmount = cart.reduce((sum, item) => sum + item.price, 0);

      try {
        await addDoc(collection(db, "orders"), {
          user: currentUser.email,
          items: cart,
          total: totalAmount,
          createdAt: serverTimestamp()
        });

        localStorage.removeItem("cart");
        cart = [];
        renderCart();
        status.style.color = "green";
        status.textContent = "✅ Order placed successfully!";
      } catch (err) {
        status.style.color = "red";
        status.textContent = "❌ Failed to place order: " + err.message;
      }
    });

    renderCart();
  </script>
</body>
</html>
